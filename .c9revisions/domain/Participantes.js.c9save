{"ts":1352952281985,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"function Service(app) {\n\tvar Participante = app.db.model('Participante');\n\n\tfunction getParticipantes(req, res, next) {\n\t\tvar query = (function() {\n\t\t\tif (req.params.id) {\n\t\t\t\treturn {\n\t\t\t\t\t_id: req.params.id\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {};\n\t\t})();\n\n\t\t// Find by Id\n\t\tif (query._id) {\n\t\t\tParticipante.findOne(query, function(err, r) {\n\t\t\t\treq.participante = r;\n\t\t\t\tnext();\n\t\t\t});\n\t\t}\n\t\t// Find by All\n\t\telse {\n\t\t\tParticipante.find(query).sort({\n\t\t\t\tnombre: 'asc'\n\t\t\t}).exec(function(err, records) {\n\t\t\t\treq.participantes = records;\n\t\t\t\tnext();\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction postParticipantes(req, res, next) {\n\t\tvar data = req.body;\n\t\tvar model = new Participante(data);\n\t\tmodel.save(function(err, r) {\n\t\t\treq.participante = r;\n\t\t\tnext();\n\t\t});\n\t}\n\n\tfunction putParticipantes(req, res, next) {\n\t\tvar data = req.body;\n\t\tvar id = req.params.id;\n\t\tParticipante.update({\n\t\t\t_id: id\n\t\t}, data, function(err, r) {\n\t\t\tif (err) {\n\t\t\t\tres.error = true;\n\t\t\t}\n\t\t\tnext();\n\t\t});\n\t}\n\n\tfunction delParticipantes(req, res, next) {\n\t\tvar id = req.params.id;\n\t\tParticipante.findByIdAndRemove(id, function(err, r) {\n\t\t\tnext();\n\t\t});\n\t}\n\n\tfunction getEquipamiento(req, res, next) {\n\t\tvar Equipamiento = app.db.model('Equipamiento');\n\t\tEquipamiento.findById(req.params.equipamiento_id, function(err, r) {\n\t\t\treq.equipamiento = r;\n\t\t\tnext();\n\t\t});\n\t}\n\n\tfunction getEquipFromParticipanteId(req, res, next) {\n\t\tvar Equipamiento = app.db.model('Equipamiento');\n\t\tEquipamiento.findById(req.participante.equipamiento_id, function(err, r) {\n\t\t\treq.equipamiento = r;\n\t\t\tnext();\n\t\t});\n\t}\n\n    function postAsistencia(req, res, next) {\n        var Asistencia = app.db.model('Asistencia');\n        \n        var query = {\n            participante_id: req.params.id,\n            taller_id: req.params.taller_id\n        };\n        \n        Asistencia.find(query, function(err, r) {\n            var asistencia = req.body.asistencia;\n            var observacion = req.body.observacion;\n            if(err) {\n                res.send(err, 500)\n                return\n            }\n            \n            if(!err && !r) {\n                if(asistencia) query.asistencia = asistencia;\n                if(observacion) query.observacion = observacion;\n                crearAsistencia(query);\n            } else {\n                console.log(r)\n                if(asistencia) r.asistencia = asistencia;\n                if(observacion) r.observacion = observacion;\n                r.save(function() {\n                    req.asistencia = r.toObject();\n                    next();   \n                });\n            }\n        });\n\n        function crearAsistencia(data) {\n            var obj = new Asistencia(data)\n            obj.save(function(err, r) {\n                req.asistencia = r.toObject();\n                next();\n            });\n        }\n\n    }\n\n\n\t/*\n     * JSON\n     */\n\tapp.get('/participantes.json', getParticipantes, function(req, res) {\n\t\tres.send(req.participantes);\n\t});\n\n\tapp.get('/participantes/:id.json', getParticipantes, function(req, res) {\n\t\tres.send(req.participante);\n\t});\n\n\tapp.post('/participantes', postParticipantes, function(req, res) {\n\t\tres.send(req.participante, 201);\n\t});\n\n    app.post('/participantes/:id/taller/:taller_id', postAsistencia, function(req, res) {\n\t\tres.send({ ok: true }, 200);\n\t});\n\n    app.put('/participantes/:id', putParticipantes, function(req, res) {\n\t\tif (req.error) res.send({\n\t\t\t'error': true\n\t\t}, 500);\n\t\telse res.send({\n\t\t\t'ok': true\n\t\t});\n\t});\n\n\tapp.del('/participantes/:id', delParticipantes, function(req, res) {\n\t\tres.send({\n\t\t\t'ok': true\n\t\t});\n\t});\n\n\n    /*\n     * HTML\n     */\n\tapp.get('/participantes', getParticipantes, function(req, res) {\n\t\tres.render('participantes', {\n\t\t\tlocals: {\n\t\t\t\tarticulo: \"Participantes\",\n\t\t\t\tparticipantes: req.participantes\n\t\t\t}\n\t\t});\n\t});\n\n\n\tapp.get('/consultas/participantes/equipamiento/:id', function(req, res) {\n\t\tParticipante.find({\n\t\t\t'equipamiento_id': req.params.id\n\t\t}, function(err, participantes) {\n\t\t\tif (err) {\n\t\t\t\tconsole.log(err);\n\t\t\t}\n\t\t\tres.render('partials/lista_participantes', {\n\t\t\t\tlayout: false,\n\t\t\t\tlocals: {\n\t\t\t\t\tarticulo: 'Participantes',\n\t\t\t\t\tparticipantes: participantes\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n\n\tapp.get('/consultas/participantes', getParticipantes, function(req, res) {\n\t\tres.render('partials/lista_participantes', {\n\t\t\tlayout: false,\n\t\t\tlocals: {\n\t\t\t\tarticulo: 'Participantes',\n\t\t\t\tparticipantes: req.participantes\n\t\t\t}\n\t\t});\n\t});\n\n\t// Agregar Participante a Equipamiento\n\tapp.get('/equipamientos/:equipamiento_id/participantes/new', getEquipamiento, function(req, res) {\n\t\tres.render('forms/participante', {\n\t\t\tlocals: {\n\t\t\t\tequipamiento: req.equipamiento,\n\t\t\t\tparams: app.params,\n\t\t\t\tarticulo: 'FormParticipante'\n\t\t\t}\n\t\t});\n\t});\n\n\tapp.get('/participantes/:id/edit', getParticipantes, getEquipFromParticipanteId, function(req, res) {\n\t\tres.render('view_edit_participante', {\n\t\t\tlocals: {\n\t\t\t\tparticipante: req.participante,\n\t\t\t\tequipamiento: req.equipamiento,\n\t\t\t\tparams: app.params,\n\t\t\t\tarticulo: 'EditarParticipante',\n\t\t\t}\n\t\t});\n\t});\n\n\tapp.get('/participantes/:id', getParticipantes, getEquipFromParticipanteId, function(req, res) {\n\t\tres.render('view_edit_participante', {\n\t\t\tlocals: {\n\t\t\t\tparticipante: req.participante,\n\t\t\t\tequipamiento: req.equipamiento,\n\t\t\t\tparams: app.params,\n\t\t\t\tarticulo: 'VerParticipante',\n\t\t\t}\n\t\t});\n\t});\n}\n\nmodule.exports = Service;"]],"start1":0,"start2":0,"length1":0,"length2":5344}]],"length":5344}
{"ts":1352952426890,"patch":[[{"diffs":[[0,"} else {"],[1," "],[0,"\n       "]],"start1":2252,"start2":2252,"length1":16,"length2":17}]],"length":5345,"saved":false}
