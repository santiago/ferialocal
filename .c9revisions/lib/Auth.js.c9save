{"ts":1352831131815,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var everyauth = require('everyauth');\nvar Store = require('./Store');\n\nvar IdentityStore = Store('Identity', {\n    source: { type: String },\n    user_id: { type: String },\n    date: { type: Date, 'default': Date.now }\n});\n\nmodule.exports = function(app) {\n    var env = app.env;\n    \n    everyauth.debug = true;\n\n    var usersById = {};\n    var usersByGoogleId = {};\n\n    var auth = {\n        development: {\n            facebook: {\n                appId: '290491051026125',\n                appSecret: 'b3f20e1678af9d70dfc0a4aad9f156af'\n            },\n            google: {\n                clientId: '634411416057.apps.googleusercontent.com',\n                clientSecret: '0YvhqMI0F7Vn2dlh-sDlZrQx'\n            },\n            twitter: ''\n        },\n\n        production: {\n            facebook: {\n                appId: '385877844809808',\n                appSecret: 'c7149334401b7bd293222ba587ef4f1b'\n            },\n            google: {\n                clientId: '634411416057-3gt1246874h496k1iak4rqpvmqm99r2e.apps.googleusercontent.com',\n                clientSecret: 'wzBAL0PyTGm5kh9YEZ02Ygbo'\n            },\n            twitter: ''\n        }\n    };\n\n    /*  @context EveryAuth\n     *\n     */\n    function addUser(source, identity, _promise) {\n        var promise = _promise || this.Promise();\n        var model = new IdentityStore({\n            source: source,\n            user_id: identity.id\n        });\n        model.save(function(err, r) {\n            if (err) {\n                promise.fail(err);\n            } else {\n                promise.fulfill(r);\n            }\n        });\n        return promise;\n    }\n\n    /*  @context EveryAuth\n     *\n     */\n    function checkUser(source, identity) {\n        var promise = this.Promise();\n        var self = this;\n\n        IdentityStore.findOne({ source: source, user_id: identity.id }, function(err, r) {\n            if (err) {\n                promise.fulfill(['failed']);\n            }\n            if (r) {\n                r = r.toObject();\n                r.id = r._id;\n                promise.fulfill(r);\n            } else {\n                addUser.call(self, source, identity, promise);\n            }\n        });\n        return promise;        \n    }\n\n    everyauth.facebook.appId(auth[env].facebook.appId).appSecret(auth[env].facebook.appSecret).findOrCreateUser(function(session, accessToken, accessTokenExtra, fbUserMetadata) {\n        session._user = fbUserMetadata;\n        return checkUser.call(this, 'facebook', fbUserMetadata);\n    }).redirectPath('/');\n\n    everyauth.google.appId(auth[env].google.clientId).appSecret(auth[env].google.clientSecret).scope('https://www.googleapis.com/auth/userinfo.profile https://www.google.com/m8/feeds/').findOrCreateUser(function(sess, accessToken, extra, googleUser) {\n        googleUser.refreshToken = extra.refresh_token;\n        googleUser.expiresIn = extra.expires_in;\n        return usersByGoogleId[googleUser.id] || (usersByGoogleId[googleUser.id] = addUser('google', googleUser));\n    }).redirectPath('/');\n    \n    everyauth.everymodule.findUserById(function(id, callback) {\n        IdentityStore.findById(id, function(err, r) {\n            callback(err, r);\n        });\n    });\n}"]],"start1":0,"start2":0,"length1":0,"length2":3193}]],"length":3193}
{"contributors":[],"silentsave":false,"ts":1352831179575,"patch":[[{"diffs":[[0," '38"],[-1,"587784480980"],[1,"038818870749"],[0,"8',\n"]],"start1":818,"start2":818,"length1":20,"length2":20},{"diffs":[[0,"t: '"],[-1,"c7149334401b7bd293222ba587ef4f1b"],[1,"9953d6b8f8d88733162288eec6f4da74"],[0,"'\n  "]],"start1":862,"start2":862,"length1":40,"length2":40}]],"length":3193,"saved":false}
{"ts":1352833575268,"patch":[[{"diffs":[[0,"d: '"],[-1,"290491051026125"],[1,"380388188707498"],[0,"',\n "]],"start1":452,"start2":452,"length1":23,"length2":23},{"diffs":[[0,"t: '"],[-1,"b3f20e1678af9d70dfc0a4aad9f156af"],[1,"9953d6b8f8d88733162288eec6f4da74"],[0,"'\n  "]],"start1":498,"start2":498,"length1":40,"length2":40}]],"length":3193,"saved":false}
